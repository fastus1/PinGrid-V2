---
phase: 01-foundation-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/shared/config/database.js
  - backend/src/app.js
  - backend/.env.example
autonomous: true

must_haves:
  truths:
    - "Connection pool max/min/maxUses/statement_timeout are configurable via environment variables without code changes"
    - "A database connection error is logged but does not crash the Node.js process"
    - "API responses are gzip/Brotli compressed (verifiable via Content-Encoding header)"
  artifacts:
    - path: "backend/src/shared/config/database.js"
      provides: "Env-configurable pool with safe error handler"
      contains: "process.env.DB_POOL_MAX"
    - path: "backend/src/app.js"
      provides: "Compression middleware registered before routes"
      contains: "compression()"
    - path: "backend/.env.example"
      provides: "Pool configuration env var documentation"
      contains: "DB_POOL_MAX"
  key_links:
    - from: "backend/src/shared/config/database.js"
      to: "pg Pool constructor"
      via: "parseInt(process.env.DB_POOL_MAX, 10) || 20"
      pattern: "parseInt\\(process\\.env\\.DB_POOL"
    - from: "backend/src/shared/config/database.js"
      to: "pool.on('error')"
      via: "console.error only, no process.exit"
      pattern: "console\\.error.*idle client"
    - from: "backend/src/app.js"
      to: "compression middleware"
      via: "app.use(compression()) before routes"
      pattern: "app\\.use\\(compression\\(\\)\\)"
---

<objective>
Harden the backend connection pool configuration and add response compression.

Purpose: Make pool sizing, timeouts, and connection lifecycle configurable without code changes. Prevent process crashes from transient database errors. Compress API responses for faster delivery.
Output: Updated database.js with env-configurable pool and safe error handler, app.js with compression middleware, .env.example with new pool env vars.
</objective>

<execution_context>
@/root/.claude/get-shit-done/workflows/execute-plan.md
@/root/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-hardening/01-RESEARCH.md

@backend/src/shared/config/database.js
@backend/src/app.js
@backend/.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace hardcoded pool config with env vars and fix error handler</name>
  <files>backend/src/shared/config/database.js, backend/.env.example</files>
  <action>
  Replace the entire Pool constructor in `backend/src/shared/config/database.js` with env-configurable options. The current file hardcodes `max: 20` and is missing `min`, `maxUses`, and `statement_timeout`. The error handler calls `process.exit(-1)` which must be removed.

  Specific changes to database.js:
  1. Replace Pool constructor with:
     - `max: parseInt(process.env.DB_POOL_MAX, 10) || 20`
     - `min: parseInt(process.env.DB_POOL_MIN, 10) || 2`
     - `maxUses: parseInt(process.env.DB_POOL_MAX_USES, 10) || 7500`
     - `idleTimeoutMillis: parseInt(process.env.DB_POOL_IDLE_TIMEOUT, 10) || 30000`
     - `connectionTimeoutMillis: parseInt(process.env.DB_POOL_CONNECTION_TIMEOUT, 10) || 5000`
     - `statement_timeout: parseInt(process.env.DB_STATEMENT_TIMEOUT, 10) || 30000`
     - Keep existing `host`, `port`, `database`, `user`, `password` env vars as-is
     - Use `parseInt(process.env.DB_PORT, 10) || 5432` for port (current code lacks parseInt)
  2. Replace `pool.on('error')` handler: remove `process.exit(-1)`, keep `console.error('Unexpected error on idle client:', err.message)` only. pg-pool auto-removes and replaces broken idle clients -- no manual intervention needed.
  3. Keep the `pool.on('connect')` handler as-is (but remove the emoji from the log message to keep logs parseable).

  Specific changes to .env.example:
  4. Add a new section after the Database Configuration block:
     ```
     # Database Pool Configuration
     DB_POOL_MAX=20
     DB_POOL_MIN=2
     DB_POOL_MAX_USES=7500
     DB_POOL_IDLE_TIMEOUT=30000
     DB_POOL_CONNECTION_TIMEOUT=5000
     DB_STATEMENT_TIMEOUT=30000
     ```

  Do NOT change any other parts of the file. Do NOT add new require statements (pg and dotenv are already imported).
  </action>
  <verify>
  - Read database.js and confirm: no `process.exit` anywhere in the file, `parseInt(process.env.DB_POOL_MAX` present, `statement_timeout` present, `min:` present, `maxUses:` present.
  - Read .env.example and confirm: `DB_POOL_MAX`, `DB_POOL_MIN`, `DB_POOL_MAX_USES`, `DB_POOL_IDLE_TIMEOUT`, `DB_POOL_CONNECTION_TIMEOUT`, `DB_STATEMENT_TIMEOUT` are all present.
  </verify>
  <done>Pool constructor uses 6 env vars with sensible defaults. Error handler logs but does not crash. .env.example documents all pool env vars.</done>
</task>

<task type="auto">
  <name>Task 2: Add response compression middleware</name>
  <files>backend/src/app.js</files>
  <action>
  Install the `compression` npm package and register it in the Express middleware stack.

  1. Run `cd backend && npm install compression` to add the dependency.
  2. In `backend/src/app.js`:
     - Add `const compression = require('compression');` at the top with the other requires (after helmet, before dotenv).
     - Add `app.use(compression());` AFTER the helmet/cors middleware and BEFORE the body parsing middleware. The correct insertion point is immediately after the `app.use(cors({...}));` block (line 26) and before `app.use(express.json());` (line 29). This ensures all responses (including JSON API responses) are compressed.
     - Do NOT pass any options to `compression()` -- the defaults (1KB threshold, gzip for all compressible content types) are correct. Brotli support is built-in since compression v1.8.0.

  Do NOT move or modify any existing middleware. Do NOT change route registrations.
  </action>
  <verify>
  - Read app.js and confirm: `compression` is required, `app.use(compression())` appears before `app.use(express.json())` and after `app.use(cors(...))`.
  - Run `cd backend && node -e "require('compression')"` to verify the package is installed.
  - Check package.json includes compression: `grep compression backend/package.json`.
  </verify>
  <done>compression middleware is installed and registered in the correct position in the Express middleware stack. All compressible API responses will be gzip/Brotli compressed automatically.</done>
</task>

</tasks>

<verification>
After both tasks, verify the complete plan:
1. `grep -c 'process.exit' backend/src/shared/config/database.js` returns 0
2. `grep 'DB_POOL_MAX' backend/src/shared/config/database.js` returns a match
3. `grep 'statement_timeout' backend/src/shared/config/database.js` returns a match
4. `grep 'compression' backend/src/app.js` returns matches for both require and app.use
5. `grep 'DB_POOL_MAX' backend/.env.example` returns a match
6. `grep 'compression' backend/package.json` returns a match
</verification>

<success_criteria>
- database.js pool is configurable via 6 env vars (DB_POOL_MAX, DB_POOL_MIN, DB_POOL_MAX_USES, DB_POOL_IDLE_TIMEOUT, DB_POOL_CONNECTION_TIMEOUT, DB_STATEMENT_TIMEOUT)
- database.js error handler does not call process.exit
- app.js has compression middleware before routes
- .env.example documents all new pool env vars
- compression package is in backend/package.json dependencies
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-hardening/01-01-SUMMARY.md`
</output>
